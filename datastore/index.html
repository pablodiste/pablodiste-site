
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.3.1, mkdocs-material-8.4.0">
    
    
      
        <title>DataStore - pablodiste</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.69437709.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.cbb835fc.min.css">
        
          
          
          <meta name="theme-color" content="#000000">
        
      
      
    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="black" data-md-color-accent="deep-orange">
  
    
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#datastore" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="pablodiste" class="md-header__button md-logo" aria-label="pablodiste" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            pablodiste
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              DataStore
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/pablodiste/data-store" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    DataStore
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="pablodiste" class="md-nav__button md-logo" aria-label="pablodiste" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    pablodiste
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/pablodiste/data-store" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.1.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    DataStore
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        Home
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          DataStore
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        DataStore
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics" class="md-nav__link">
    Basics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-usage" class="md-nav__link">
    Example of Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-application" class="md-nav__link">
    Sample Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    Features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-datastore" class="md-nav__link">
    Using DataStore
  </a>
  
    <nav class="md-nav" aria-label="Using DataStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-defining-your-data-classes" class="md-nav__link">
    1. Defining your data classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-creating-a-store" class="md-nav__link">
    2. Creating a Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-define-a-key" class="md-nav__link">
    3. Define a Key.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-implement-the-fetcher" class="md-nav__link">
    4. Implement the Fetcher
  </a>
  
    <nav class="md-nav" aria-label="4. Implement the Fetcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrofit-fetcher" class="md-nav__link">
    Retrofit Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ktor-fetcher" class="md-nav__link">
    Ktor Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-fetcher-libraries" class="md-nav__link">
    Other fetcher libraries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-implement-the-source-of-truth" class="md-nav__link">
    5. Implement the Source of Truth
  </a>
  
    <nav class="md-nav" aria-label="5. Implement the Source of Truth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-room" class="md-nav__link">
    Using Room
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-realm-database" class="md-nav__link">
    Using Realm database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-memory-source-of-truth" class="md-nav__link">
    In-memory source of truth
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-using-the-store" class="md-nav__link">
    6. Using the Store
  </a>
  
    <nav class="md-nav" aria-label="6. Using the Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instancing-your-store" class="md-nav__link">
    Instancing your Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#responses" class="md-nav__link">
    Responses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stream-data" class="md-nav__link">
    Stream data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-an-api-call-directly" class="md-nav__link">
    Making an API call directly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-data-from-source-of-truth-no-api" class="md-nav__link">
    Getting the data from source of truth (no API)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-of-main-methods" class="md-nav__link">
    Summary of main methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staleness-settings" class="md-nav__link">
    Staleness Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoiding-multiple-repeated-calls" class="md-nav__link">
    Avoiding multiple repeated calls
  </a>
  
    <nav class="md-nav" aria-label="Avoiding multiple repeated calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forcing-a-fetch-ignoring-the-rate-limiter" class="md-nav__link">
    Forcing a fetch ignoring the rate limiter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-the-rate-limiter" class="md-nav__link">
    Disabling the Rate Limiter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joining-in-progress-calls" class="md-nav__link">
    Joining in-progress calls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retries" class="md-nav__link">
    Retries
  </a>
  
    <nav class="md-nav" aria-label="Retries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configurable-retry" class="md-nav__link">
    Configurable Retry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-a-fetcher" class="md-nav__link">
    Disable a Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling-a-single-fetcher-on-server-errors" class="md-nav__link">
    Throttling a single fetcher on server errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling-all-active-fetchers-on-server-errors" class="md-nav__link">
    Throttling all active fetchers on server errors
  </a>
  
    <nav class="md-nav" aria-label="Throttling all active fetchers on server errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#throttling-configuration" class="md-nav__link">
    Throttling configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-throttling" class="md-nav__link">
    Disabling throttling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#showing-throttling-errors-on-the-ui" class="md-nav__link">
    Showing throttling errors on the UI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing-error-responses-retrofit" class="md-nav__link">
    Parsing Error Responses (Retrofit)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-states" class="md-nav__link">
    Loading States
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crud-stores" class="md-nav__link">
    CRUD Stores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling_1" class="md-nav__link">
    Error handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributions" class="md-nav__link">
    Contributions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roadmap" class="md-nav__link">
    Roadmap
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#basics" class="md-nav__link">
    Basics
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-of-usage" class="md-nav__link">
    Example of Usage
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#sample-application" class="md-nav__link">
    Sample Application
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#features" class="md-nav__link">
    Features
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#using-datastore" class="md-nav__link">
    Using DataStore
  </a>
  
    <nav class="md-nav" aria-label="Using DataStore">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#installation" class="md-nav__link">
    Installation
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#1-defining-your-data-classes" class="md-nav__link">
    1. Defining your data classes
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-creating-a-store" class="md-nav__link">
    2. Creating a Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-define-a-key" class="md-nav__link">
    3. Define a Key.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#4-implement-the-fetcher" class="md-nav__link">
    4. Implement the Fetcher
  </a>
  
    <nav class="md-nav" aria-label="4. Implement the Fetcher">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#retrofit-fetcher" class="md-nav__link">
    Retrofit Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ktor-fetcher" class="md-nav__link">
    Ktor Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#other-fetcher-libraries" class="md-nav__link">
    Other fetcher libraries
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#5-implement-the-source-of-truth" class="md-nav__link">
    5. Implement the Source of Truth
  </a>
  
    <nav class="md-nav" aria-label="5. Implement the Source of Truth">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#using-room" class="md-nav__link">
    Using Room
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#using-realm-database" class="md-nav__link">
    Using Realm database
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#in-memory-source-of-truth" class="md-nav__link">
    In-memory source of truth
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#6-using-the-store" class="md-nav__link">
    6. Using the Store
  </a>
  
    <nav class="md-nav" aria-label="6. Using the Store">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#instancing-your-store" class="md-nav__link">
    Instancing your Store
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#responses" class="md-nav__link">
    Responses
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stream-data" class="md-nav__link">
    Stream data
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#making-an-api-call-directly" class="md-nav__link">
    Making an API call directly
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#getting-the-data-from-source-of-truth-no-api" class="md-nav__link">
    Getting the data from source of truth (no API)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#summary-of-main-methods" class="md-nav__link">
    Summary of main methods
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    Error handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#staleness-settings" class="md-nav__link">
    Staleness Settings
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#avoiding-multiple-repeated-calls" class="md-nav__link">
    Avoiding multiple repeated calls
  </a>
  
    <nav class="md-nav" aria-label="Avoiding multiple repeated calls">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#forcing-a-fetch-ignoring-the-rate-limiter" class="md-nav__link">
    Forcing a fetch ignoring the rate limiter
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-the-rate-limiter" class="md-nav__link">
    Disabling the Rate Limiter
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#joining-in-progress-calls" class="md-nav__link">
    Joining in-progress calls
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retries" class="md-nav__link">
    Retries
  </a>
  
    <nav class="md-nav" aria-label="Retries">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#configurable-retry" class="md-nav__link">
    Configurable Retry
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disable-a-fetcher" class="md-nav__link">
    Disable a Fetcher
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling-a-single-fetcher-on-server-errors" class="md-nav__link">
    Throttling a single fetcher on server errors
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#throttling-all-active-fetchers-on-server-errors" class="md-nav__link">
    Throttling all active fetchers on server errors
  </a>
  
    <nav class="md-nav" aria-label="Throttling all active fetchers on server errors">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#throttling-configuration" class="md-nav__link">
    Throttling configuration
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#disabling-throttling" class="md-nav__link">
    Disabling throttling
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#showing-throttling-errors-on-the-ui" class="md-nav__link">
    Showing throttling errors on the UI
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#parsing-error-responses-retrofit" class="md-nav__link">
    Parsing Error Responses (Retrofit)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#loading-states" class="md-nav__link">
    Loading States
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#crud-stores" class="md-nav__link">
    CRUD Stores
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling_1" class="md-nav__link">
    Error handling
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#contributions" class="md-nav__link">
    Contributions
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#roadmap" class="md-nav__link">
    Roadmap
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
  <a href="https://github.com/pablodiste/data-store/edit/master/docs/datastore.md" title="Edit this page" class="md-content__button md-icon">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25Z"/></svg>
  </a>



<h1 id="datastore">DataStore</h1>
<p><a href="https://search.maven.org/search?q=g:dev.pablodiste.datastore"><img alt="GitHub release" src="https://img.shields.io/maven-central/v/dev.pablodiste.datastore/datastore" /></a></p>
<p>DataStore is an implementation of the Repository pattern in Android. This library allows async loading and caching data from different sources (API, databases).</p>
<h2 id="basics">Basics</h2>
<p>A Store is composed of two main objects, a fetcher, and a source of truth.</p>
<ul>
<li><strong>Fetcher</strong>: In charge of calling the API and getting the result in the form of a <code>FetcherResult&lt;Entity&gt;</code>.</li>
<li><strong>Source of Truth</strong>: In charge of storing the result locally and making queries, usually backed by a local database.</li>
</ul>
<h2 id="example-of-usage">Example of Usage</h2>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="c1">// Repository code</span><span class="w"></span>
<a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">providePeopleStore</span><span class="p">():</span><span class="w"> </span><span class="n">Store</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a><span class="w">    </span><span class="n">SimpleStoreBuilder</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a><span class="w">        </span><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideStarWarsService</span><span class="p">().</span><span class="na">getPeople</span><span class="p">().</span><span class="na">results</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a><span class="w">        </span><span class="n">cache</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">.</span><span class="na">peopleCache</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a><span class="w">    </span><span class="p">).</span><span class="na">build</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>
<a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a><span class="c1">// In the Viewmodel</span><span class="w"></span>
<a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a><span class="kd">val</span><span class="w"> </span><span class="nv">peopleStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">providePeopleStore</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a><span class="w">    </span><span class="n">peopleStore</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">refresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">).</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a><span class="w">        </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Hello </span><span class="si">${</span><span class="n">result</span><span class="p">.</span><span class="na">value</span><span class="p">.</span><span class="na">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a><span class="w">        </span><span class="n">uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="na">value</span><span class="w"></span>
<a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
This example will fetch a People list from an API, then store it in a local database and listen reactively for updates on that list.</p>
<p>Please see the documentation below about how to provide a fetcher and a source of truth using your preferred libraries.</p>
<h2 id="sample-application">Sample Application</h2>
<p>You can see the features working by cloning this repository and running the <code>app</code> module.</p>
<h2 id="features">Features</h2>
<ul>
<li>Handles caching of fetched data automatically.</li>
<li>Allows listening to changes on the source of truth and making queries.</li>
<li>It is built on coroutines.</li>
<li>Allows the integration of different fetcher sources and libraries (Retrofit, Ktor).</li>
<li>Includes support for source of truth based on Room and Realm libraries but you can plug in other ones too.</li>
<li>Allows configuration of custom database queries (like DAOs)</li>
<li>Allows per-request source of truth expiration configuration.</li>
<li>Implements a way to limit multiple repeated calls to the same API.</li>
<li>Supports retries using exponential backoff on fetcher errors.</li>
<li>Implements throttling on API errors. You can be notified if throttling is activated and show proper error messaging in the UI.</li>
<li>Implements CRUDStores, a very simple interface to make Create, Read, Update and Delete operations over APIs and reflect the state updates automatically in the source of truth.</li>
<li>(WIP) Implements writable stores.</li>
</ul>
<h2 id="using-datastore">Using DataStore</h2>
<h3 id="installation">Installation</h3>
<p>Include the library in the dependencies section of your module configuration file. For example using Kotlin:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;dev.pablodiste.datastore:datastore:0.1.9&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>Plugins for integrating DataStore with common libraries, you only need to include the ones you need</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;dev.pablodiste.datastore:datastore-room:0.1.8&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;dev.pablodiste.datastore:datastore-realm:0.1.2&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;dev.pablodiste.datastore:datastore-retrofit:0.1.8&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="n">implementation</span><span class="p">(</span><span class="s">&quot;dev.pablodiste.datastore:datastore-ktor:0.1.8&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h3 id="1-defining-your-data-classes">1. Defining your data classes</h3>
<p>The Store will be in charge of fetching data from the API and caching the data on a local repository (database). You can define data classes for holding the information parsed from the API, for example with GSon or Moshi libraries, and also you can define data classes for the data which is going to be stored in the database.</p>
<p>You can either define different data classes for API and Database or use the same definition, depending on your needs. In the following examples we are going to use the same entity class for simplicity.</p>
<p>Here is a Room entity.
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="nd">@Entity</span><span class="p">(</span><span class="n">tableName</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;people&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">People</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w">    </span><span class="nd">@PrimaryKey</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w">    </span><span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;name&quot;</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">name</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w">    </span><span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;height&quot;</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">height</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w">    </span><span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;mass&quot;</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">mass</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w">    </span><span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;gender&quot;</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">gender</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a><span class="w">    </span><span class="nd">@ColumnInfo</span><span class="p">(</span><span class="n">name</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;url&quot;</span><span class="p">)</span><span class="w"> </span><span class="kd">var</span><span class="w"> </span><span class="nv">url</span><span class="p">:</span><span class="w"> </span><span class="kt">String?</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">null</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a><span class="p">)</span><span class="w"></span>
</code></pre></div></p>
<h3 id="2-creating-a-store">2. Creating a Store</h3>
<p>You can create a basic store using a functional builder this way:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">providePersonStore</span><span class="p">():</span><span class="w"> </span><span class="n">Store</span><span class="o">&lt;</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"></span>
<a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w">    </span><span class="n">SimpleStoreBuilder</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w">        </span><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideStarWarsService</span><span class="p">().</span><span class="na">getPerson</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w">        </span><span class="n">sourceOfTruth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">.</span><span class="na">personSourceOfTruth</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w">    </span><span class="p">).</span><span class="na">build</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
<p>As an alternative we have few base classes you can use for creating an Store. These are useful if you want to add additional methods to your repository.</p>
<ul>
<li><code>StoreImpl&lt;K: Any, I: Any, T: Any&gt;</code> is the main implementation, it requires you to provide K a key for the request, I is the class to be used by the fetcher and T is the class to be used by the source of truth.</li>
<li><code>SimpleStoreImpl</code> is a helper class where I = T, we are going to be using the same data class for fetching and storing.</li>
<li><code>NoKeySimpleStore</code> is a <code>SimpleStoreImpl</code> where the Key is NoKey. Please read the Key section for more information on Keys.</li>
</ul>
<p>For example:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">PeopleStore</span><span class="p">:</span><span class="w"> </span><span class="n">NoKeySimpleStore</span><span class="o">&lt;</span><span class="n">List</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w">    </span><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PeopleFetcher</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w">    </span><span class="n">sourceOfTruth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PeopleSourceOfTruth</span><span class="p">())</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w">    </span><span class="p">...</span><span class="w"></span>
<a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
Defines a store which will fetch using a fetcher based on the entity People, and it will store it in a source of truth database using the same Entity.</p>
<h3 id="3-define-a-key">3. Define a Key.</h3>
<p>A <code>Key</code> is a parametric data class used to identify the API request operation. This <code>Key</code> can be any class with a <code>toString</code> implementation. Its fields are used to provide parameters to the API and it is also used as a unique identifier for each API Request, so we can avoid multiple repeated calls.</p>
<p>In case our endpoint requires a parameter id, we can do:
<div class="highlight"><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w">    </span><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">Key</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"></span>
</code></pre></div></p>
<p>In case you need to fetch a list of entities without any parameters, or there is no field which could identify the request, you can use an existing <code>NoKey</code> implementation instead of creating your own.
This key should be referenced in the generic parameter K of the store definition. For example: <code>SimpleStoreImpl&lt;PeopleStore.Key, People&gt;</code>.</p>
<h3 id="4-implement-the-fetcher">4. Implement the Fetcher</h3>
<p>The fetcher fetches data from an API and returns a FetcherResults. Fetcher is a functional interface so you can provide it to the store using just a lambda.
<div class="highlight"><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideStarWarsService</span><span class="p">().</span><span class="na">getPerson</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="c1">// or also</span><span class="w"></span>
<a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Fetcher</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideStarWarsService</span><span class="p">().</span><span class="na">getPerson</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
In this example <code>provideStarWarsService()</code> provides the API service which makes the call to the server.</p>
<p>We also have a builder method which creates a fetcher with the <code>joinInProgressCalls</code> and <code>limit</code> operators on it. Please see ahead in the docs for more information about how to configure fetchers with more options.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">FetcherBuilder</span><span class="p">.</span><span class="na">of</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideStarWarsService</span><span class="p">().</span><span class="na">getPerson</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>We have also available a couple of helper integrations to most common fetcher libraries.
The advantage of using these helpers is not only less boilerplate code but also they handle automatically the specific library errors.</p>
<h4 id="retrofit-fetcher">Retrofit Fetcher</h4>
<p>Including the retrofit integration, you can use the following code to create a Retrofit fetcher.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="n">RetrofitFetcher</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">retrofitService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="n">RoomStarWarsService</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getStarships</span><span class="p">().</span><span class="na">results</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here <code>retrofitService</code> is a service instance created with <code>Retrofit.create</code>. You can find more details in the sample application source code.</p>
<p>There is also a helper class you can use if you do not want to build Retrofit services using the functional approach.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">PeopleFetcher</span><span class="p">:</span><span class="w"> </span><span class="n">RetrofitFetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">StarWarsService</span><span class="o">&gt;</span><span class="p">(</span><span class="n">RetrofitManager</span><span class="p">.</span><span class="na">starWarsService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">suspend</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">fetch</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="n">StarWarsService</span><span class="p">):</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w">        </span><span class="kd">val</span><span class="w"> </span><span class="nv">people</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getPeople</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="n">people</span><span class="p">.</span><span class="na">results</span><span class="w"></span>
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here <code>RetrofitManager.starWarsService</code> and <code>StarWarsService</code> is a Retrofit service definition interface.</p>
<h4 id="ktor-fetcher">Ktor Fetcher</h4>
<p>Similar to the Retrofit integration you can use Ktor as HTTP client.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="n">KtorFetcher</span><span class="p">.</span><span class="na">of</span><span class="p">(</span><span class="n">ktorService</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">:</span><span class="w"> </span><span class="n">KtorStarWarsService</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">service</span><span class="p">.</span><span class="na">getStarships</span><span class="p">().</span><span class="na">results</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>It works the same way as Retrofit, please check the sample project for the implementation details.</p>
<h4 id="other-fetcher-libraries">Other fetcher libraries</h4>
<p>You can also use other libraries or provide your own code to fetch data, you just need to make the call in the fetch function and return a <code>FetcherResult</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="n">Fetcher</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideAPIService</span><span class="p">().</span><span class="na">getPerson</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="5-implement-the-source-of-truth">5. Implement the Source of Truth</h3>
<h4 id="using-room">Using Room</h4>
<p>We have provided base DAOs for using with Room:</p>
<ul>
<li><code>RoomSourceOfTruth</code> stores individual objects. This type of source of truth is used, for example, when fetching data from APIs which return a single entity in the response.</li>
<li><code>RoomListSourceOfTruth</code> stores a list of entities. This type of source of truth is used, for example, when fetching data from APIs which return a list of entities as a response.</li>
</ul>
<p>For example if we want to store a list of People we can do:
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="nd">@Dao</span><span class="w"></span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PeopleSourceOfTruth</span><span class="p">:</span><span class="w"> </span><span class="n">RoomListSourceOfTruth</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;people&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">NoKey</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
The <code>query</code> is the filter to be used to retrieve the stored data which has been stored after the API call. It generally matches the parameters sent to the API.
For example if we are fetching an entity by id, our SourceOfTruth class will look like this one:
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nd">@Dao</span><span class="w"></span>
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PersonSourceOfTruth</span><span class="p">:</span><span class="w"> </span><span class="n">RoomSourceOfTruth</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;people&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;id = </span><span class="si">${</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="si">}</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
All created DAOs automatically generate the required methods for making it work with the Store, but you can also add your own methods for using the source of truth directly as a regular Room DAO.</p>
<p>The created DAOs should be connected with your Room Database implementation, for example:
<div class="highlight"><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a><span class="nd">@Database</span><span class="p">(</span><span class="n">entities</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n">People</span><span class="o">::</span><span class="n">class</span><span class="o">]</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">AppDatabase</span><span class="w"> </span><span class="p">:</span><span class="w"> </span><span class="n">RoomDatabase</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a><span class="w">    </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">peopleSourceOfTruth</span><span class="p">():</span><span class="w"> </span><span class="n">RoomPeopleStore</span><span class="p">.</span><span class="na">PeopleSourceOfTruth</span><span class="w"></span>
<a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="w">    </span><span class="kd">abstract</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">personSourceOfTruth</span><span class="p">():</span><span class="w"> </span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">PersonSourceOfTruth</span><span class="w"></span>
<a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
and you need to provide the DAO as the source of truth in the Store:
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">RoomPersonStore</span><span class="p">:</span><span class="w"> </span><span class="n">SimpleStoreImpl</span><span class="o">&lt;</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="w">    </span><span class="n">fetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PersonFetcher</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="w">    </span><span class="n">sourceOfTruth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">.</span><span class="na">personSourceOfTruth</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="p">)</span><span class="w"></span>
</code></pre></div>
Please refer to the Room implementation for more details on the Database definition.</p>
<h4 id="using-realm-database">Using Realm database</h4>
<p>In case we are using <code>Realm</code> we can use:
<div class="highlight"><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">PeopleSourceOfTruth</span><span class="p">:</span><span class="w"> </span><span class="n">RealmListSourceOfTruth</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="n">People</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">NoKey</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="p">:</span><span class="w"> </span><span class="n">RealmQuery</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
The <code>query</code> is the filter to be used to retrieve the stored data which has been stored after the API call. It generally matches the parameters sent to the API.
For example if we are fetching an entity by id, our SourceOfTruth class will look like this one:
<div class="highlight"><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">PersonSourceOfTruth</span><span class="p">:</span><span class="w"> </span><span class="n">RealmSourceOfTruth</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="n">People</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="p">:</span><span class="w"> </span><span class="n">RealmQuery</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="w">        </span><span class="nb">it</span><span class="p">.</span><span class="na">equalTo</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
Optionally you can provide a <code>storeInRealm</code> which implements a custom method to persist to the Realm source of truth.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">class</span><span class="w"> </span><span class="nc">PersonCache</span><span class="p">:</span><span class="w"> </span><span class="n">RealmSourceOfTruth</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="n">People</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">query</span><span class="p">:</span><span class="w"> </span><span class="n">RealmQuery</span><span class="o">&lt;</span><span class="n">People</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Unit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">equalTo</span><span class="p">(</span><span class="s">&quot;id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">storeInRealm</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">bgRealm</span><span class="p">:</span><span class="w"> </span><span class="n">Realm</span><span class="p">,</span><span class="w"> </span><span class="n">entity</span><span class="p">:</span><span class="w"> </span><span class="n">People</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">bgRealm</span><span class="p">.</span><span class="na">copyToRealmOrUpdate</span><span class="p">(</span><span class="n">entity</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// Custom code</span><span class="w"></span>
<a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="in-memory-source-of-truth">In-memory source of truth</h4>
<p>It is available an implementation of the source of truth which stores the data in-memory. The data is not persisted to disk, it will not be available after restarting the app. It is useful for storing temporary or short lived information.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">Key</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">cid</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">Entity</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">cid</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">,</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">name</span><span class="p">:</span><span class="w"> </span><span class="kt">String</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>
<a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="kd">class</span><span class="w"> </span><span class="nc">InMemoryEntityListSOT</span><span class="p">:</span><span class="w"> </span><span class="n">InMemoryListSourceOfTruth</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Entity</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">predicate</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">):</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">:</span><span class="w"> </span><span class="n">Entity</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="kt">Boolean</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">value</span><span class="p">.</span><span class="na">cid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">key</span><span class="p">.</span><span class="na">cid</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>This example shows a version storing a list of fetcher results. You can also use <code>InMemorySourceOfTruth</code> for storing single values.
The predicate is a function you provide to filter out the data in relation to key, similar to the query in the other source of truth implementations. When requesting data with <code>get</code> or <code>stream</code> only the items matching the provided predicate are returned. </p>
<h3 id="6-using-the-store">6. Using the Store</h3>
<p>These are the main methods for using the Store we just created:</p>
<h4 id="instancing-your-store">Instancing your Store</h4>
<div class="highlight"><pre><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">peopleStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PeopleStore</span><span class="p">()</span><span class="w"> </span><span class="c1">// or injected using DI</span><span class="w"></span>
</code></pre></div>
<p>All operations using the store are usually tied to a scope, we can use the viewModelScope for example to launch a coroutine that listens for the incoming data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">RealmPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>With some databases like Realm we should close the opened resources when we are done with using the data. We have provided some extension functions for closing the Realm instances automatically.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="p">(</span><span class="n">personStore</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">RealmPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a><span class="w">    </span><span class="c1">// ...</span><span class="w"></span>
<a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<p>Here in the launch we provide the store instance and it will close itself once the coroutine job is canceled (finished).
As an alternative, we have an additional method to close many stores.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a><span class="w">    </span><span class="c1">// Use peopleStore and planetStore</span><span class="w"></span>
<a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a><span class="p">}.</span><span class="na">autoClose</span><span class="p">(</span><span class="n">peopleStore</span><span class="p">,</span><span class="w"> </span><span class="n">planetStore</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h4 id="responses">Responses</h4>
<p>All responses coming from the store are based on StoreResponse classes. The subclasses are:</p>
<table>
<thead>
<tr>
<th>StoreResponse</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Data</td>
<td>When the request was successful it returns the parsed objects</td>
</tr>
<tr>
<td>Error</td>
<td>This is returned when there was a network or parsing error. It includes the exception that generated it. Please note Store will not throw the exception</td>
</tr>
<tr>
<td>NoData</td>
<td>This is returned when there is no data to return, for example when the fetch operation has not been executed. Please note NoData is not returned when the API returns an empty result set.</td>
</tr>
</tbody>
</table>
<h4 id="stream-data">Stream data</h4>
<p>The <code>stream</code> method does the following:
1. Checks the source of truth looking for any stored data, if there is any, it is emitted immediately.
2. If the <code>refresh</code> parameter is <code>true</code>, it calls the Fetcher for new data from the API and stores them. Then it will emit the new data. If stored data existed before the fetch, you will receive <strong>two emissions</strong>: one for the previously stored data and another one for the new data after the fetch has completed.
3. If initially there was no data on the source of truth, it performs the API call. Then its result gets stored in the source of truth and emitted to the client.
4. Stream keeps listening and emitting any update in the stored data.</p>
<p>For example, from your ViewModel
<div class="highlight"><pre><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">    </span><span class="n">peopleStore</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">refresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">).</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<a id="__codelineno-25-3" name="__codelineno-25-3" href="#__codelineno-25-3"></a><span class="w">        </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-25-4" name="__codelineno-25-4" href="#__codelineno-25-4"></a><span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">refreshUI</span><span class="p">()</span><span class="w"> </span><span class="c1">// Here you send it to the UI</span><span class="w"></span>
<a id="__codelineno-25-5" name="__codelineno-25-5" href="#__codelineno-25-5"></a><span class="w">            </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">showError</span><span class="p">()</span><span class="w"> </span><span class="c1">// You can show an error </span><span class="w"></span>
<a id="__codelineno-25-6" name="__codelineno-25-6" href="#__codelineno-25-6"></a><span class="w">            </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">handleNoData</span><span class="p">()</span><span class="w"> </span><span class="c1">// You can also handle the NoData showing an error </span><span class="w"></span>
<a id="__codelineno-25-7" name="__codelineno-25-7" href="#__codelineno-25-7"></a><span class="w">        </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-25-8" name="__codelineno-25-8" href="#__codelineno-25-8"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-25-9" name="__codelineno-25-9" href="#__codelineno-25-9"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<code>stream</code> returns a <code>Flow</code>, and it can be combined and processed like any other <code>Flow</code>.</p>
<p>You can also add <code>.map { it.requireData() }</code> in case you want the errors to be thrown and handled in a different way.</p>
<h4 id="making-an-api-call-directly">Making an API call directly</h4>
<p>The <code>fetch</code> method makes an API call, stores the result and then it returns the new data. It does not check the source of truth for any previously existing data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-26-2" name="__codelineno-26-2" href="#__codelineno-26-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">PersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-26-3" name="__codelineno-26-3" href="#__codelineno-26-3"></a><span class="w">    </span><span class="n">Log</span><span class="p">.</span><span class="na">d</span><span class="p">(</span><span class="n">TAG</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;Fetch response: </span><span class="si">${</span><span class="n">response</span><span class="p">.</span><span class="na">value</span><span class="si">}</span><span class="s">&quot;</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-26-4" name="__codelineno-26-4" href="#__codelineno-26-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="getting-the-data-from-source-of-truth-no-api">Getting the data from source of truth (no API)</h4>
<p>The <code>get</code> method gets the data from the source of truth, usually used in places when you know the data should be already stored. If there is no data in the source of truth, it automatically tries to fetch the data from API. <code>get</code> is a suspend function and it does not keep listening for changes, it returns the current status of the stored data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">get</span><span class="p">(</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h4 id="summary-of-main-methods">Summary of main methods</h4>
<table>
<thead>
<tr>
<th>method</th>
<th>feature</th>
</tr>
</thead>
<tbody>
<tr>
<td>stream</td>
<td>Gets the data first from the source of truth, then from the API and listens for source of truth updates. It usually emits twice or more times (old and new data)</td>
</tr>
<tr>
<td>fetch</td>
<td>Gets the data from the API and stores it.</td>
</tr>
<tr>
<td>get</td>
<td>Gets the data from the source of truth. It does not listen for updates.</td>
</tr>
</tbody>
</table>
<h4 id="error-handling">Error handling</h4>
<p>You can detect errors in different ways:
<div class="highlight"><pre><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a><span class="w">    </span><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="w">    </span><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">result</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a><span class="w">        </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="c1">// UI work</span><span class="w"></span>
<a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a><span class="w">        </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="c1">// Handle the error here</span><span class="w"></span>
<a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a><span class="w">        </span><span class="k">else</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">{}</span><span class="w"></span>
<a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a><span class="w">    </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
Another alternative is using the catch method after a <code>requireData()</code> call.
<div class="highlight"><pre><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a><span class="w">    </span><span class="n">personStore</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a><span class="w">        </span><span class="p">.</span><span class="na">map</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">it</span><span class="p">.</span><span class="na">requireData</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a><span class="w">        </span><span class="p">.</span><span class="na">catch</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="cm">/* Error handling */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a><span class="w">        </span><span class="p">.</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="cm">/* UI work */</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-29-6" name="__codelineno-29-6" href="#__codelineno-29-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h3 id="staleness-settings">Staleness Settings</h3>
<p>When we are calling the API to fetch a list of resources, we usually perform a GET call and the returned items are stored in the source of truth. If there are entities that were deleted in the backend, the API response will not contain them anymore, and the source of truth will still have them stored -and they will appear in local queries-. In order to sync the data and delete the source of truth items properly we have different strategies.</p>
<p>The staleness strategy is configured in the SourceOfTruth. For example using Room:
<div class="highlight"><pre><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="nd">@Dao</span><span class="w"></span>
<a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PeopleSourceOfTruth</span><span class="p">:</span><span class="w"> </span><span class="n">RoomListSourceOfTruth</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">People</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;people&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">,</span><span class="w"></span>
<a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="w">    </span><span class="n">stalenessPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DeleteAllNotInFetchStalenessPolicy</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">people</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">people</span><span class="p">.</span><span class="na">id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="c1">// Example of staleness settings.</span><span class="w"></span>
<a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">NoKey</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;&quot;</span><span class="w"></span>
<a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<table>
<thead>
<tr>
<th>stalenessPolicy</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DoNotExpireStalenessPolicy</code></td>
<td>Avoids calling any DELETE on the database when new data arrives. No data is deleted, only updates are performed.</td>
</tr>
<tr>
<td><code>DeleteAllStalenessPolicy</code></td>
<td>Calls DELETE doing a query using the query method of the SourceOfTruth.</td>
</tr>
<tr>
<td><code>DeleteAllNotInFetchStalenessPolicy</code></td>
<td>Calls DELETE on all database rows which are not in the API response. You should provide a function which indicates a way to compare the old and new items, usually a primary key.</td>
</tr>
</tbody>
</table>
<h3 id="avoiding-multiple-repeated-calls">Avoiding multiple repeated calls</h3>
<p>It is very common in big applications to request the same information from many different locations in the app. In order to avoid doing repeated API calls returning the same data, the <code>Store</code> implements a <code>LimitedFetcher</code>.</p>
<p>The limiter can be configured with <code>duration</code> and an <code>eventCount</code>. For example you can configure a fetcher to limit the calls to 10 calls per minute this way.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a><span class="w">  </span><span class="p">.</span><span class="na">limit</span><span class="p">(</span><span class="n">rateLimitPolicy</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RateLimitPolicy</span><span class="p">.</span><span class="na">FixedWindowPolicy</span><span class="p">(</span><span class="n">duration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.</span><span class="n">minutes</span><span class="p">,</span><span class="w"> </span><span class="n">eventCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">10</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>In this example, the limiter will allow 10 calls in the first minute (the window duration), any additional call in the first minute will not be executed and <code>NoData</code> will be returned instead. Once the minute has passed, 10 more calls will be enabled.</p>
<p>The default implementation uses <code>RateLimitPolicy.FixedWindowPolicy(duration = 5.seconds)</code>. We have other options available:</p>
<table>
<thead>
<tr>
<th>rateLimitPolicy</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>FixedWindowPolicy</code></td>
<td>It lets you define a number of calls and a time window. The first N times you make an API call it will proceed, if you make a subsequent call inside the time window provided, it will NOT make an API call. Once the time has passed the timeout threshold, the next call will go to the API again with the same logic. Example: <code>RateLimitPolicy.FixedWindowPolicy(duration = 10.seconds)</code></td>
</tr>
<tr>
<td><code>FetchOnlyOnce</code></td>
<td>It calls the API only once in the app lifetime. Please note if you restart the app, the fetcher will fetch again.</td>
</tr>
<tr>
<td><code>FetchAlways</code></td>
<td>It does not limit the API calls in any way.</td>
</tr>
</tbody>
</table>
<h4 id="forcing-a-fetch-ignoring-the-rate-limiter">Forcing a fetch ignoring the rate limiter</h4>
<p>If you need to force a fetch to the API ignoring the rate limiter, you should send a parameter to the <code>fetch</code> call the following way:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">personStore</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">RoomPersonStore</span><span class="p">.</span><span class="na">Key</span><span class="p">(</span><span class="s">&quot;1&quot;</span><span class="p">),</span><span class="w"> </span><span class="n">forced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<h4 id="disabling-the-rate-limiter">Disabling the Rate Limiter</h4>
<p>You can disable all rate limiters with the code:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1" href="#__codelineno-33-1"></a><span class="n">StoreConfig</span><span class="p">.</span><span class="na">isRateLimiterEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-33-2" name="__codelineno-33-2" href="#__codelineno-33-2"></a><span class="w">    </span><span class="c1">// You can use a feature flag or a remote config here to return a Boolean </span><span class="w"></span>
<a id="__codelineno-33-3" name="__codelineno-33-3" href="#__codelineno-33-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
If you want to disable it for a specific call, you can check the <code>FetchAlways</code> rate limit policy.</p>
<h3 id="joining-in-progress-calls">Joining in-progress calls</h3>
<p>We have available one operator that works the following way: it detects if there is any in flight fetcher call, then any concurrent repeated call will wait for the result of the first one and it will return the same result as the original. 
This helps to reduce the amount of calls to the backend. It can be used in combination of the rate limiter.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1" href="#__codelineno-34-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-34-2" name="__codelineno-34-2" href="#__codelineno-34-2"></a><span class="w">  </span><span class="p">.</span><span class="na">joinInProgressCalls</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
<h3 id="retries">Retries</h3>
<p>You can configure retries for a fetcher call this way:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1" href="#__codelineno-35-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-35-2" name="__codelineno-35-2" href="#__codelineno-35-2"></a><span class="w">  </span><span class="p">.</span><span class="na">retry</span><span class="p">(</span><span class="n">RetryPolicy</span><span class="p">.</span><span class="na">ExponentialBackoff</span><span class="p">(</span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>The retry extension is supported in all fetcher implementations (Retrofit, Ktor, custom). The alternatives are:</p>
<table>
<thead>
<tr>
<th>retryPolicy</th>
<th>description</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>DoNotRetry</code></td>
<td>It does not retry the fetcher call on failures. This is the default.</td>
</tr>
<tr>
<td><code>ExponentialBackoff</code></td>
<td>When the fetcher returns a <code>FetcherResult.Error</code>, the fetch is retried until <code>maxRetries</code>. The time between retries can be controlled by the <code>initialBackoff</code> and <code>backoffRate</code> params.</td>
</tr>
</tbody>
</table>
<h4 id="configurable-retry">Configurable Retry</h4>
<p>You can configure <code>ExponentialBackoff</code> policy so the retry only happens when receiving certain HTTP response codes. For example:</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1" href="#__codelineno-36-1"></a><span class="n">RetryPolicy</span><span class="p">.</span><span class="na">ExponentialBackoff</span><span class="p">(</span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">retryOnErrorCodes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">listOf</span><span class="p">(</span><span class="m">500</span><span class="p">,</span><span class="w"> </span><span class="m">501</span><span class="p">,</span><span class="w"> </span><span class="m">502</span><span class="p">))</span><span class="w"></span>
</code></pre></div>
<p>This config will retry only when the server returns 500, 501 or 502 error codes.
You can also configure a custom retryOn function like the following example. The fetcher will retry only if <code>retryOn</code> function returns <code>true</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1" href="#__codelineno-37-1"></a><span class="n">RetryPolicy</span><span class="p">.</span><span class="na">ExponentialBackoff</span><span class="p">(</span><span class="n">maxRetries</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">retryOn</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="p">...</span><span class="w"> </span><span class="p">})</span><span class="w"></span>
</code></pre></div>
<h3 id="disable-a-fetcher">Disable a Fetcher</h3>
<p>You can disable a fetcher under certain conditions with this operator. When the fetcher is disabled it returns <code>NoData</code>.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1" href="#__codelineno-38-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-38-2" name="__codelineno-38-2" href="#__codelineno-38-2"></a><span class="w">  </span><span class="p">.</span><span class="na">disableOn</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">isLoggedIn</span><span class="p">().</span><span class="na">not</span><span class="p">()</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
</code></pre></div>
<h3 id="throttling-a-single-fetcher-on-server-errors">Throttling a single fetcher on server errors</h3>
<p>With this operator you can detect if multiple errors are happening in the server and avoid sending requests for some time. 
Throttling will be applied on HTTP errors, for example 500 errors when a service or group of services are down. </p>
<p>Basic usage looks like this</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1" href="#__codelineno-39-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-39-2" name="__codelineno-39-2" href="#__codelineno-39-2"></a><span class="w">  </span><span class="p">.</span><span class="na">throttleOnError</span><span class="p">(</span><span class="n">maxErrorCount</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">3</span><span class="p">,</span><span class="w"> </span><span class="n">errorWindowDuration</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1.</span><span class="n">minutes</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>In this example, if 3 or more errors are returned by the server in a window of 1 minute before the last request time up until the last request time, the store will return <code>ThrottlingError</code> exception on each subsequent fetcher call for 5 seconds (<code>initialBackoff</code>) and the fetcher requests done in that timeframe will not be executed.
The throttling timeframe will grow exponentially after new errors arrive.</p>
<p>You can configure with <code>initialBackoff</code> the throttling timeframe after the errors has been detected, and with <code>backoffRate</code> its growth rate.</p>
<p>Throttling is activated by default with any HTTP error code returned but you can configure the HTTP error codes to consider passing them in the <code>throttleOnErrorCodes</code> parameter, or you can also set up a custom error detector with <code>throttleOn</code> functional parameter.</p>
<h3 id="throttling-all-active-fetchers-on-server-errors">Throttling all active fetchers on server errors</h3>
<p>You can enable throttling of service calls in case of continuously failing requests. Sometimes backends and servers are not able to process the requests fast enough, or they are down, or they experience temporary issues. In that case, the Store clients are able to wait some time before making the next call.
It works the following way: If there are more than a configurable amount of errors in a row, the next service calls during a timeframe will result in an immediate local exception and they will not be executed.
You can also configure a base timeframe until a next call is allowed. If the time has passed and there is another error this timeframe grows exponentially to avoid flooding the server with retries or repeated calls.</p>
<blockquote>
<p>The throttled requests are not retried automatically nor queued (yet), they result in a throttling error. You can configure a retry with the retry fetcher operator.</p>
</blockquote>
<div class="highlight"><pre><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1" href="#__codelineno-40-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-40-2" name="__codelineno-40-2" href="#__codelineno-40-2"></a><span class="w">  </span><span class="p">.</span><span class="na">throttleAllStoresOnError</span><span class="p">()</span><span class="w"></span>
</code></pre></div>
<h4 id="throttling-configuration">Throttling configuration</h4>
<p>You can configure the throttling setting <code>StoreConfig.throttlingConfiguration</code>.</p>
<table>
<thead>
<tr>
<th>Property</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>errorCountThreshold</td>
<td>Amount of errors in a row since the throttling is activated.</td>
</tr>
<tr>
<td>throttleInitialTimeout</td>
<td>Duration of the throttling period in milliseconds.</td>
</tr>
<tr>
<td>errorDurationThreshold</td>
<td>The timeout period will grow exponentially if the API errors continue happening, until reaching this duration in milliseconds.</td>
</tr>
</tbody>
</table>
<h4 id="disabling-throttling">Disabling throttling</h4>
<p>The throttling is active by default, but you can disable it for debugging purposes this way:
<div class="highlight"><pre><span></span><code><a id="__codelineno-41-1" name="__codelineno-41-1" href="#__codelineno-41-1"></a><span class="n">StoreConfig</span><span class="p">.</span><span class="na">isThrottlingEnabled</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-41-2" name="__codelineno-41-2" href="#__codelineno-41-2"></a><span class="w">    </span><span class="c1">// You can use a feature flag or a remote config here to return a Boolean</span><span class="w"></span>
<a id="__codelineno-41-3" name="__codelineno-41-3" href="#__codelineno-41-3"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h4 id="showing-throttling-errors-on-the-ui">Showing throttling errors on the UI</h4>
<p><code>ThrottlingFetcherController</code> exposes a <code>throttlingState</code> state flow you can use in the UI. The state includes <code>isThrottling</code> boolean indicating if throttling is currently active, and <code>timestampUntilNextCall</code> the unix timestamp to the date-time in which you can resume making calls or retry them.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-42-1" name="__codelineno-42-1" href="#__codelineno-42-1"></a><span class="c1">// In the ViewModel</span><span class="w"></span>
<a id="__codelineno-42-2" name="__codelineno-42-2" href="#__codelineno-42-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">throttlingState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StoreConfig</span><span class="p">.</span><span class="na">throttlingController</span><span class="p">.</span><span class="na">throttlingState</span><span class="w"></span>
<a id="__codelineno-42-3" name="__codelineno-42-3" href="#__codelineno-42-3"></a>
<a id="__codelineno-42-4" name="__codelineno-42-4" href="#__codelineno-42-4"></a><span class="c1">// In the View / Compose</span><span class="w"></span>
<a id="__codelineno-42-5" name="__codelineno-42-5" href="#__codelineno-42-5"></a><span class="kd">val</span><span class="w"> </span><span class="nv">throttlingState</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">viewModel</span><span class="p">.</span><span class="na">throttlingState</span><span class="p">.</span><span class="na">collectAsState</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-42-6" name="__codelineno-42-6" href="#__codelineno-42-6"></a><span class="c1">// Then you can use throttlingState.value.isThrottling to know if it is throttling.</span><span class="w"></span>
</code></pre></div>
<h3 id="parsing-error-responses-retrofit">Parsing Error Responses (Retrofit)</h3>
<p>We have a helper for retrofit helpers which allows parsing of error responses. This is useful to get more information about the server error response.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-43-1" name="__codelineno-43-1" href="#__codelineno-43-1"></a><span class="n">Fetcher</span><span class="o">&lt;</span><span class="n">NoKey</span><span class="p">,</span><span class="w"> </span><span class="n">List</span><span class="o">&lt;</span><span class="n">Post</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPosts</span><span class="p">())</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-43-2" name="__codelineno-43-2" href="#__codelineno-43-2"></a><span class="w">  </span><span class="p">.</span><span class="na">deserializeError</span><span class="o">&lt;</span><span class="n">Key</span><span class="p">,</span><span class="w"> </span><span class="n">Entity</span><span class="p">,</span><span class="w"> </span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">(</span><span class="n">retrofit</span><span class="p">)</span><span class="w"></span>
</code></pre></div>
<p>You have to provide <code>ErrorModel</code>, the type of the model used to deserialize the error response. We need to send the <code>retrofit</code> instance as well, the entity will be deserialized using the converter configured in Retrofit.
In order to get the error response, the store returns a <code>FetcherException</code> from which you can get the fetcher error with the parsed data.</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-44-1" name="__codelineno-44-1" href="#__codelineno-44-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">store</span><span class="p">.</span><span class="na">fetch</span><span class="p">(</span><span class="n">Key</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-44-2" name="__codelineno-44-2" href="#__codelineno-44-2"></a><span class="kd">val</span><span class="w"> </span><span class="nv">fetcherError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">result</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Error</span><span class="p">).</span><span class="na">error</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">FetcherException</span><span class="p">).</span><span class="na">fetcherError</span><span class="w"></span>
<a id="__codelineno-44-3" name="__codelineno-44-3" href="#__codelineno-44-3"></a><span class="kd">val</span><span class="w"> </span><span class="nv">parsedError</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">fetcherError</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">FetcherError</span><span class="p">.</span><span class="na">EntityHttpError</span><span class="o">&lt;</span><span class="n">ErrorModel</span><span class="o">&gt;</span><span class="p">).</span><span class="na">errorResult</span><span class="w"></span>
</code></pre></div>
<h3 id="loading-states">Loading States</h3>
<p>You can configure the store to send a loading state in the stream flow. When enabled, <code>Loading</code> is sent when the Fetcher starts a network call.</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-45-1" name="__codelineno-45-1" href="#__codelineno-45-1"></a><span class="n">store</span><span class="p">.</span><span class="na">stream</span><span class="p">(</span><span class="n">StoreRequest</span><span class="p">(</span><span class="n">key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NoKey</span><span class="p">(),</span><span class="w"> </span><span class="n">refresh</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span><span class="w"> </span><span class="n">emitLoadingStates</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">)).</span><span class="na">collect</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"></span>
<a id="__codelineno-45-2" name="__codelineno-45-2" href="#__codelineno-45-2"></a><span class="w">  </span><span class="c1">// Result can be Loading</span><span class="w"></span>
<a id="__codelineno-45-3" name="__codelineno-45-3" href="#__codelineno-45-3"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-45-4" name="__codelineno-45-4" href="#__codelineno-45-4"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
You can use this, for example, to show a loading indicator when receiving <code>Loading</code> and hiding it when receiving <code>Data</code> or <code>Error</code>.
Please note if you call <code>fetch</code> or any other method that generates a network call, you also need to provide <code>emitLoadingStates = true</code> to the <code>StoreRequest</code> to receive <code>Loading</code> states.
This is specially helpful when implementing refresh buttons, pull-to-refresh or swipe-to-refresh interactions, you can listen to the <code>stream</code> and you can call <code>fetch</code> to perform a network call. An example is provided in the demo code.</p>
<h3 id="crud-stores">CRUD Stores</h3>
<p>A CrudStore is a Store which also implements create, update and delete methods.
These operations are reflected in API calls (POST, PUT and DELETE REST calls for example), and the new/updated/deleted entities are also created/updated/deleted in the source of truth when the API call succeeds.
This is a very simple implementation and it does not consider making changes on a working thread.</p>
<p>Example of definition:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-46-1" name="__codelineno-46-1" href="#__codelineno-46-1"></a><span class="kd">data</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PostKey</span><span class="p">(</span><span class="kd">val</span><span class="w"> </span><span class="nv">id</span><span class="p">:</span><span class="w"> </span><span class="kt">Int</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-46-2" name="__codelineno-46-2" href="#__codelineno-46-2"></a>
<a id="__codelineno-46-3" name="__codelineno-46-3" href="#__codelineno-46-3"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">providePostsCRUDStore</span><span class="p">():</span><span class="w"> </span><span class="n">SimpleCrudStoreImpl</span><span class="o">&lt;</span><span class="n">PostKey</span><span class="p">,</span><span class="w"> </span><span class="n">Post</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-46-4" name="__codelineno-46-4" href="#__codelineno-46-4"></a><span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="n">SimpleCrudStoreBuilder</span><span class="p">.</span><span class="na">from</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-46-5" name="__codelineno-46-5" href="#__codelineno-46-5"></a><span class="w">    </span><span class="n">crudFetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CrudFetcher</span><span class="p">(</span><span class="w"></span>
<a id="__codelineno-46-6" name="__codelineno-46-6" href="#__codelineno-46-6"></a><span class="w">      </span><span class="n">readFetcher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">getPost</span><span class="p">(</span><span class="n">post</span><span class="p">.</span><span class="na">id</span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-46-7" name="__codelineno-46-7" href="#__codelineno-46-7"></a><span class="w">      </span><span class="n">createSender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">createPost</span><span class="p">(</span><span class="n">post</span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-46-8" name="__codelineno-46-8" href="#__codelineno-46-8"></a><span class="w">      </span><span class="n">updateSender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Data</span><span class="p">(</span><span class="n">provideService</span><span class="p">().</span><span class="na">updatePost</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="p">))</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-46-9" name="__codelineno-46-9" href="#__codelineno-46-9"></a><span class="w">      </span><span class="n">deleteSender</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">post</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">provideService</span><span class="p">().</span><span class="na">deletePost</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="p">);</span><span class="w"> </span><span class="n">FetcherResult</span><span class="p">.</span><span class="na">Success</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="p">},</span><span class="w"></span>
<a id="__codelineno-46-10" name="__codelineno-46-10" href="#__codelineno-46-10"></a><span class="w">    </span><span class="p">),</span><span class="w"></span>
<a id="__codelineno-46-11" name="__codelineno-46-11" href="#__codelineno-46-11"></a><span class="w">    </span><span class="n">sourceOfTruth</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dev</span><span class="p">.</span><span class="na">pablodiste</span><span class="p">.</span><span class="na">datastore</span><span class="p">.</span><span class="na">sample</span><span class="p">.</span><span class="na">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">.</span><span class="na">postSourceOfTruth</span><span class="p">(),</span><span class="w"></span>
<a id="__codelineno-46-12" name="__codelineno-46-12" href="#__codelineno-46-12"></a><span class="w">    </span><span class="n">keyBuilder</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">entity</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">PostKey</span><span class="p">(</span><span class="n">entity</span><span class="p">.</span><span class="na">id</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-46-13" name="__codelineno-46-13" href="#__codelineno-46-13"></a><span class="w">  </span><span class="p">).</span><span class="na">build</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-46-14" name="__codelineno-46-14" href="#__codelineno-46-14"></a><span class="p">}</span><span class="w"></span>
<a id="__codelineno-46-15" name="__codelineno-46-15" href="#__codelineno-46-15"></a>
<a id="__codelineno-46-16" name="__codelineno-46-16" href="#__codelineno-46-16"></a><span class="kd">private</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">provideService</span><span class="p">()</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RetrofitManager</span><span class="p">.</span><span class="na">createService</span><span class="p">(</span><span class="n">JsonPlaceholderService</span><span class="o">::</span><span class="n">class</span><span class="p">.</span><span class="na">java</span><span class="p">)</span><span class="w"></span>
<a id="__codelineno-46-17" name="__codelineno-46-17" href="#__codelineno-46-17"></a>
<a id="__codelineno-46-18" name="__codelineno-46-18" href="#__codelineno-46-18"></a><span class="nd">@Dao</span><span class="w"></span>
<a id="__codelineno-46-19" name="__codelineno-46-19" href="#__codelineno-46-19"></a><span class="kd">abstract</span><span class="w"> </span><span class="kd">class</span><span class="w"> </span><span class="nc">PostCache</span><span class="p">:</span><span class="w"> </span><span class="n">RoomCache</span><span class="o">&lt;</span><span class="n">PostKey</span><span class="p">,</span><span class="w"> </span><span class="n">Post</span><span class="o">&gt;</span><span class="p">(</span><span class="s">&quot;posts&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">SampleApplication</span><span class="p">.</span><span class="na">roomDb</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-46-20" name="__codelineno-46-20" href="#__codelineno-46-20"></a><span class="w">    </span><span class="kd">override</span><span class="w"> </span><span class="kd">fun</span><span class="w"> </span><span class="nf">query</span><span class="p">(</span><span class="n">key</span><span class="p">:</span><span class="w"> </span><span class="n">PostKey</span><span class="p">):</span><span class="w"> </span><span class="kt">String</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;id = </span><span class="si">${</span><span class="n">key</span><span class="p">.</span><span class="na">id</span><span class="si">}</span><span class="s">&quot;</span><span class="w"></span>
<a id="__codelineno-46-21" name="__codelineno-46-21" href="#__codelineno-46-21"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
Some details:</p>
<ul>
<li><code>PostKey</code> is the key used to identify each request, in this example the id is used to distinguish between different entities.</li>
<li><code>providePostsCRUDStore</code> creates the CRUD Store, we provide one parameter for each CRUD operation: <code>create</code>, <code>update</code>, <code>delete</code>, and <code>read</code>. We also need to provide a <code>keyBuilder</code> function used to generate a new key for the new stored data.</li>
<li>The source of truth in this case is a Room Dao with a query using the key provided.</li>
</ul>
<p>The usage is simple:</p>
<p><div class="highlight"><pre><span></span><code><a id="__codelineno-47-1" name="__codelineno-47-1" href="#__codelineno-47-1"></a><span class="kd">private</span><span class="w"> </span><span class="kd">val</span><span class="w"> </span><span class="nv">postsStore</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">providePostsCRUDStore</span><span class="p">()</span><span class="w"></span>
<a id="__codelineno-47-2" name="__codelineno-47-2" href="#__codelineno-47-2"></a><span class="c1">//...</span><span class="w"></span>
<a id="__codelineno-47-3" name="__codelineno-47-3" href="#__codelineno-47-3"></a><span class="kd">fun</span><span class="w"> </span><span class="nf">create</span><span class="p">()</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-4" name="__codelineno-47-4" href="#__codelineno-47-4"></a><span class="w">  </span><span class="n">viewModelScope</span><span class="p">.</span><span class="na">launch</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-47-5" name="__codelineno-47-5" href="#__codelineno-47-5"></a><span class="w">    </span><span class="n">postsStore</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">PostKey</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">Post</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Body&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-47-6" name="__codelineno-47-6" href="#__codelineno-47-6"></a><span class="w">    </span><span class="n">uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Created&quot;</span><span class="w"> </span><span class="c1">// Here you can show a success message</span><span class="w"></span>
<a id="__codelineno-47-7" name="__codelineno-47-7" href="#__codelineno-47-7"></a><span class="w">  </span><span class="p">}</span><span class="w"></span>
<a id="__codelineno-47-8" name="__codelineno-47-8" href="#__codelineno-47-8"></a><span class="p">}</span><span class="w"></span>
</code></pre></div>
And similar for <code>update</code> and <code>delete</code>. The source of truth is updated as soon the response is received.
In general this CRUD requests assumes an API expecting POST/PUT/PATCH operations returning the created/updated object with the generated/edited id as a result.</p>
<h3 id="error-handling_1">Error handling</h3>
<p>The CRUD operations returns a <code>StoreResponse</code> object which can be an <code>Error</code>. None of the operations are throwing exceptions.
<div class="highlight"><pre><span></span><code><a id="__codelineno-48-1" name="__codelineno-48-1" href="#__codelineno-48-1"></a><span class="kd">val</span><span class="w"> </span><span class="nv">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">postsStore</span><span class="p">.</span><span class="na">create</span><span class="p">(</span><span class="n">PostKey</span><span class="p">(</span><span class="n">id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">),</span><span class="w"> </span><span class="n">Post</span><span class="p">(</span><span class="n">title</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Title&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">body</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Body&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">userId</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span><span class="p">))</span><span class="w"></span>
<a id="__codelineno-48-2" name="__codelineno-48-2" href="#__codelineno-48-2"></a><span class="k">when</span><span class="w"> </span><span class="p">(</span><span class="n">response</span><span class="p">)</span><span class="w"> </span><span class="p">{</span><span class="w"></span>
<a id="__codelineno-48-3" name="__codelineno-48-3" href="#__codelineno-48-3"></a><span class="w">  </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Data</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Created&quot;</span><span class="w"></span>
<a id="__codelineno-48-4" name="__codelineno-48-4" href="#__codelineno-48-4"></a><span class="w">  </span><span class="k">is</span><span class="w"> </span><span class="n">StoreResponse</span><span class="p">.</span><span class="na">Error</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="n">uiState</span><span class="p">.</span><span class="na">value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;Error in create&quot;</span><span class="w"></span>
<a id="__codelineno-48-5" name="__codelineno-48-5" href="#__codelineno-48-5"></a><span class="p">}</span><span class="w"></span>
</code></pre></div></p>
<h2 id="contributions">Contributions</h2>
<p>Any suggestion and bug report is welcome, you can create issues in the github page.
Feel free to fork it and/or send a pull request in case you want to make fixes or add any additional feature or change. 
Please create an issue in github so we can discuss the idea and collaborate.</p>
<h2 id="roadmap">Roadmap</h2>
<ul>
<li>Support of Pagination, integration with Pager3 or custom implementation.</li>
<li>Data expiration, TTL, validators.</li>
<li>SQLDelight examples and wrappers</li>
<li>Add additional testing coverage, add coverage library.</li>
<li>Support multiple responses per request, web-sockets.</li>
<li>Limiter: Implement Token RateLimiter</li>
<li>Refactor throttling code.</li>
<li>Analyze making it available for KMM.</li>
<li>Retries: Support 429 and Retry-After header</li>
<li>Support X-Rate-Limit headers.</li>
<li>Crud: Support operators (limit, retry) on Sender</li>
<li>Work in progress: Writeable Store<ul>
<li>Sender Controller and library helpers    </li>
<li>Error handling / Undo</li>
<li>On delete operation remove pending updates for that id</li>
<li>Provide a way for clients to store pending updates</li>
<li>Provide a way for clients to enable and disable worker, for example for not sending when not logged in to API.</li>
<li>Detect changes on same entity id and process only one</li>
<li>More Testing</li>
<li>Documentation</li>
</ul>
</li>
<li>Investigate if there is a way to create functional builders for the source of truth.</li>
<li>Add an optional memory cache.</li>
</ul>




              
            </article>
            
          </div>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
    
    <nav class="md-footer__inner md-grid" aria-label="Footer" >
      
        
        <a href=".." class="md-footer__link md-footer__link--prev" aria-label="Previous: Home" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              Home
            </div>
          </div>
        </a>
      
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.ecf98df9.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.9c69f0bc.min.js"></script>
      
    
  </body>
</html>